name: Process Agent Updates

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  process-update:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'memory-update') || contains(github.event.issue.labels.*.name, 'new-skill') || contains(github.event.issue.labels.*.name, 'update-skill')
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Run Tests
        run: bun test ./scripts/workflow_parser.test.ts

      - name: Apply Changes
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_LABELS: ${{ join(github.event.issue.labels.*.name, ',') }}
        run: bun run ./scripts/workflow_parser.ts

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "agent: update knowledge/memory from issue #${{ github.event.issue.number }}"
          title: "Agent Update: ${{ github.event.issue.title }}"
          body: "Auto-generated PR from Issue #${{ github.event.issue.number }}"
          branch: "agent-update-${{ github.event.issue.number }}"
          base: main
          delete-branch: true
